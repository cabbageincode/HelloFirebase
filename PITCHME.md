# Firebase -- Realtime Database

---

## Getting start...

1. install pods

```md
pod 'Firebase/Database'
```

2. import module

```md
import Firebase
```

3. 取得Firebase library裡的資料管理工具

```md
var ref: DatabaseReference!

ref = Database.database().reference()
```
---

### DatabaseReference

DatabaseReference是Firebase裡面的資料庫管理工具，指定一個path給他，代表你要操作的資料路徑。

通常是你的 App path + table path

```md
let bagPathUrl = "https://my-first-in-firebase.firebaseio.com/Bags/" + currentUser.uid
let bagRef = Database.database().reference(fromURL: bagPathUrl)
```

---

* app path : https://my-first-in-firebase.firebaseio.com
* table path : Bags
>> https://my-first-in-firebase.firebaseio.com/Bags/

<a data-flickr-embed="true" data-context="true"  href="https://www.flickr.com/photos/54996923@N06/35589568284/in/dateposted/" title="Screen Shot 2017-08-07 at 9.50.23 PM"><img src="https://farm5.staticflickr.com/4365/35589568284_053713852b.jpg" width="500" height="208" alt="Screen Shot 2017-08-07 at 9.50.23 PM"></a><script async src="//embedr.flickr.com/assets/client-code.js" charset="utf-8"></script>

---

### DatabaseReference

以下2種寫法是一樣的!!!

1. 寫法1

```md
let bagPathUrl = "https://my-first-in-firebase.firebaseio.com/Bags/" + currentUser.uid
let bagRef = Database.database().reference(fromURL: bagPathUrl)
```

2. 寫法2
app路徑下的Bags子路徑

```md
let bagRef = Database.database().reference().child("Bags").child(currentUser.uid)
```

--- 

### 用DatabaseReference添加資料

Append to a list of data

```md
Use the childByAutoId method to append data to a list in multiuser applications. The childByAutoId method generates a unique key every time a new child is added to the specified Firebase reference. By using these auto-generated keys for each new element in the list, several clients can add children to the same location at the same time without write conflicts. The unique key generated by childByAutoId is based on a timestamp, so list items are automatically ordered chronologically.
```

"childByAutoId"可以添加一筆資料，firebase會自動產生一組key當成那筆資料的unique key。

來源：[Append to a list of data](https://firebase.google.com/docs/database/ios/lists-of-data)

---

### 用DatabaseReference添加資料

```md
let bagDict = ["name": "pen", "desc": "this is a pen"]

bagRef.childByAutoId().setValue(bagDict) { (error, resultRef) in
	//...
}
```
**setValue()**：value要是一個JSON object
 * NSString
 * NSNumber
 * NSDictionary
 * NSArray

備註：[了解JSON](http://expect7.pixnet.net/blog/post/37666521)

--- 

## 動手做

1. 取得DatabaseReference

```md
let bagRef = Database.database().reference().child("Bags").child("user_a")
```

2. 新增一筆資料，name是 **pen**，desc是 **this is a pen**

```md
let bagDict = ["name": "pen", "desc": "this is a pen"]

bagRef.childByAutoId().setValue(bagDict) { (error, resultRef) in
	guard error == nil else {
        print("save bag object error... \(error.debugDescription)")
        return
    }
}
```
---

## 動手做 -- 結果

<a data-flickr-embed="true" data-context="true"  href="https://www.flickr.com/photos/54996923@N06/36288625311/in/dateposted/" title="Screen Shot 2017-08-07 at 10.26.29 PM"><img src="https://farm5.staticflickr.com/4427/36288625311_f157d3a619.jpg" width="500" height="138" alt="Screen Shot 2017-08-07 at 10.26.29 PM"></a><script async src="//embedr.flickr.com/assets/client-code.js" charset="utf-8"></script>

--- 

### 用DatabaseReference取得資料

```
bagRef.observe(.value) { snapshot in
  for child in snapshot.children {
    //...
  }
}
```
* 用 **observe** 方法觀察DatabaseReference的資料變化
* 用 **snapshot** 物件取得資料

---

### observe

observe是DatabaseReference的一個方法，用於取得DatabaseReference下的資料變化。

```
open func observe(_ eventType: DataEventType, with block: @escaping (DataSnapshot) -> Swift.Void) -> UInt
```
參數介紹：
* eventType：哪種變化會調用這個block?
**childAdded** 有資料被新增
**childRemoved** 有資料被刪除
**childChanged** 有資料被更新
**childMoved** 有資料被搬去其它位置
**value** 任何資料更新，包含query的結果

* DataSnapshot：被修改的資料，用 **snapshot.value** 取得資料本身(是一個JSON object，和setValue相同)

---


## 動手做 --延申 user bags 的功能，取得包包的內容物

1. 取得DatabaseReference

```md
let bagRef = Database.database().reference().child("Bags").child("user_a")
```

2. 建立一個畫面，透過以下方法添加不同的物件到包包裡

```
private func addObjectToMybag(name: String, desc: String) {

    let bagRef = Database.database().reference().child("Bags").child("user_a")

    let bagDict = ["name": name, "desc": desc]

    bagRef.childByAutoId().setValue(bagDict) { (error, resultRef) in
        //...
    }
}
```
---
看到你的console應該要有以下的資料↓

<a data-flickr-embed="true" data-context="true"  href="https://www.flickr.com/photos/54996923@N06/35601893664/in/dateposted/" title="Screen Shot 2017-08-08 at 11.31.24 AM"><img src="https://farm5.staticflickr.com/4371/35601893664_ed5f6b59bb.jpg" width="500" height="483" alt="Screen Shot 2017-08-08 at 11.31.24 AM"></a><script async src="//embedr.flickr.com/assets/client-code.js" charset="utf-8"></script>

---

3. 取得包包的物件list

```
bagRef.observe(.value, with: { (snapshot) in
    for child in snapshot.children {
        guard let childSnap = child as? DataSnapshot else {
            continue
        }
        guard let object = childSnap.value as? Dictionary<String, String> else {
            continue
        }
        self.objectsInMyBag.append(object)
    }
    self.tableView.reloadData()
})
```

1. snapshot.children：取得包包裡的物件list，用for迴圈去循覽他
2. 每個child都是一個獨立snapshot，用value取得JSON object
3. 加入你的datasource，然後reload table
